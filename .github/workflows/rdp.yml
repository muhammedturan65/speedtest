name: RDP Access (Windows)

on:
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Ngrok
        # Ngrok'u kurar ve RDP portunu (3389) tüneller.
        # Bu işlemin çalışması için Settings > Secrets > Actions kısmında NGROK_AUTH_TOKEN tanımlanmalıdır.
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          $token = $env:NGROK_AUTH_TOKEN
          if ($token -match "^ngrok config") {
            Write-Error "HATA: NGROK_AUTH_TOKEN içinde 'ngrok config...' komutu var. Sadece token'ı secret olarak kaydetmelisiniz."
            exit 1
          }
          
          # Winget ortam değişkenlerini anlık güncelleyemediği için ZIP yöntemine dönüyoruz (Daha kararlı)
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive "ngrok.zip" -DestinationPath "." -Force
          
          .\ngrok.exe config add-authtoken $token
          # Loglamayı açarak başlatıyoruz
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput "ngrok.log" -RedirectStandardError "ngrok_err.log" -NoNewWindow
          Start-Sleep -Seconds 5
          
      - name: Get Connection Info
        run: |
          Write-Host "Ngrok tüneli açılıyor... (API bekleniyor)"
          $timeout = 45 # Süreyi biraz artırdık
          $startTime = Get-Date
          while ($true) {
            try {
               $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -ErrorAction Stop
               if ($response.tunnels.Count -gt 0) {
                 $url = $response.tunnels[0].public_url
                 Write-Host "::notice title=RDP Connection Info::Bağlantı Adresi: $url"
                 Write-Host "::notice title=Credentials::Kullanıcı Adı: runneradmin | Şifre: (Aşağıdaki adımda ayarlanacak)"
                 break
               }
            } catch {
               Write-Host "Ngrok API henüz hazır değil, bekleniyor..."
            }
            
            if ((Get-Date) - $startTime -gt (New-TimeSpan -Seconds $timeout)) {
               Write-Host "::error::Ngrok tüneli açılamadı. Süre doldu."
               
               Write-Host "--- NGROK STANDARD LOGS ---"
               if (Test-Path "ngrok.log") { Get-Content "ngrok.log" } else { Write-Host "Log dosyası bulunamadı." }
               
               Write-Host "--- NGROK ERROR LOGS ---"
               if (Test-Path "ngrok_err.log") { Get-Content "ngrok_err.log" } else { Write-Host "Hata log dosyası bulunamadı." }
               
               Write-Host "------------------"
               Get-Process ngrok -ErrorAction SilentlyContinue
               exit 1
            }
            Start-Sleep -Seconds 2
          }
          
      - name: Set User Password
        run: |
          $password = "Mert1234!"
          net user runneradmin $password
          Write-Host "::notice title=Password Set::Kullanıcı şifresi: $password"

      - name: Keep Alive
        run: |
          Write-Host "Bağlantı açık tutuluyor... (Maksimum 6 saat)"
          while ($true) {
            Start-Sleep -Seconds 60
          }
