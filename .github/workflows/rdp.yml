name: RDP Access (Windows)

on:
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3


      - name: Enable RDP & Firewall
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          # NLA (Network Level Authentication) zorunluluğunu kapatıyoruz (Bağlantı sorununu çözer)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 0
          # Güvenlik duvarını tamamen siliyoruz (Nuclear option)
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # Servisi zorla yeniden başlatıyoruz (Ayarların geçerli olması için Restart şart)
          Set-Service -Name TermService -StartupType Automatic
          Restart-Service -Name TermService -Force
          
          # Debug: Port dinleniyor mu?
          Write-Host "Checking Port 3389..."
          netstat -an | findstr 3389
          Write-Host "Firewall Disabled, Service Restarted."

      - name: Set up Ngrok
        # Ngrok'u kurar ve RDP portunu (3389) tüneller.
        # Bu işlemin çalışması için Settings > Secrets > Actions kısmında NGROK_AUTH_TOKEN tanımlanmalıdır.
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          $token = $env:NGROK_AUTH_TOKEN
          if ($token -match "^ngrok config") {
            Write-Error "HATA: NGROK_AUTH_TOKEN içinde 'ngrok config...' komutu var. Sadece token'ı secret olarak kaydetmelisiniz."
            exit 1
          }
          
          # Winget ortam değişkenlerini anlık güncelleyemediği için ZIP yöntemine dönüyoruz (Daha kararlı)
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive "ngrok.zip" -DestinationPath "." -Force
          
          .\ngrok.exe config add-authtoken $token
          # Loglamayı açarak başlatıyoruz (Region EU eklendi)
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --region eu --log=stdout" -RedirectStandardOutput "ngrok.log" -RedirectStandardError "ngrok_err.log" -NoNewWindow
          Start-Sleep -Seconds 5
          
      - name: Get Connection Info
        run: |
          Write-Host "Ngrok tüneli açılıyor... (Log dosyası taranıyor)"
          $timeout = 60
          $startTime = Get-Date
          $found = $false
          
          while ($true) {
            if (Test-Path "ngrok.log") {
              $logContent = Get-Content "ngrok.log" -Raw
              # Log içinde 'url=tcp://...' desenini arıyoruz
              if ($logContent -match 'url=(tcp://.+?)(\s|$)') {
                $url = $matches[1]
                Write-Host "::notice title=RDP Connection Info::Bağlantı Adresi: $url"
                Write-Host "::notice title=Credentials::Kullanıcı Adı: runneradmin | Şifre: (Aşağıdaki adımda ayarlanacak)"
                $found = $true
                break
              }
            }
            
            if ((Get-Date) - $startTime -gt (New-TimeSpan -Seconds $timeout)) {
               break
            }
            Start-Sleep -Seconds 2
          }
          
          if (-not $found) {
             Write-Host "::error::Ngrok URL'i log dosyasında bulunamadı."
             Write-Host "--- NGROK LOGS ---"
             if (Test-Path "ngrok.log") { Get-Content "ngrok.log" }
             Write-Host "--- NGROK ERROR LOGS ---"
             if (Test-Path "ngrok_err.log") { Get-Content "ngrok_err.log" }
             exit 1
          }
          
      - name: Set User Password
        run: |
          $password = "Mert1234!"
          net user runneradmin $password
          Write-Host "::notice title=Password Set::Kullanıcı şifresi: $password"

      - name: Keep Alive
        run: |
          Write-Host "Bağlantı açık tutuluyor... (Maksimum 6 saat)"
          while ($true) {
            Start-Sleep -Seconds 60
          }
