name: RDP Access (Playit.gg)

on:
  workflow_dispatch:

jobs:
  rdp-playit:
    runs-on: windows-latest
    steps:
      - name: Enable RDP & Firewall
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 0
          
          # Change RDP Port to 25565 (Minecraft default) to use free tunnel
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "PortNumber" -value 25565
          
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
          
          # Explicitly allow port 25565
          New-NetFirewallRule -DisplayName "Minecraft-RDP" -Direction Inbound -LocalPort 25565 -Protocol TCP -Action Allow
          
          # Restart service to apply port change
          Set-Service -Name TermService -StartupType Automatic
          Restart-Service -Name TermService -Force
          
          # Wait for port to open
          Write-Host "Waiting for RDP service on port 25565..."
          $loopCount = 0
          while ($loopCount -lt 20) {
            $connection = Get-NetTCPConnection -LocalPort 25565 -ErrorAction SilentlyContinue
            if ($connection) {
               Write-Host "SUCCESS: RDP is listening on port 25565."
               break
            }
            Start-Sleep -Seconds 3
            $loopCount++
          }
          Write-Host "RDP Configuration Complete."

      - name: Install Playit (GitHub Release)
        run: |
          Invoke-WebRequest -Uri "https://github.com/playit-cloud/playit-agent/releases/download/v0.16.5/playit-windows-x86_64-signed.exe" -OutFile "playit.exe"
          Write-Host "Playit.exe downloaded."
          
      - name: Set User Password
        run: |
          $password = "Mert1234!"
          net user runneradmin $password
          Write-Host "::notice title=Credentials::Kullanıcı Adı: runneradmin | Şifre: $password"

      - name: Run Playit Agent
        run: |
          Write-Host "Playit Agent Başlatılıyor..."
          Write-Host "::notice title=Action Required::Lütfen Linke tıklayın ve 'Minecraft Java' Tüneli oluşturun. (Port 25565 olarak ayarlandı)."
          
          # Playit'i başlatıyoruz ve çıktısını ekrana basıyoruz ki kullanıcı linki görebilsin
          # Playit interaktif çalıştığı için background job olarak başlatıp çıktıyı okumamız lazım.
          
          $playitProcess = Start-Process -FilePath "playit" -PassThru -NoNewWindow -RedirectStandardOutput "playit.log" -RedirectStandardError "playit_err.log"
          
          Write-Host "Loglar izleniyor... Lütfen bekleyin ve linki arayın."
          
          $LinkFound = $false
          while (-not $LinkFound) {
            if (Test-Path "playit.log") {
               $content = Get-Content "playit.log"
               $content | ForEach-Object {
                 if ($_ -match "https://playit.gg/claim/") {
                   Write-Host "::notice title=CLAIM THIS LINK::Linke Tıklayın: $_"
                   Write-Host "Bulunan Link: $_"
                   $LinkFound = $true
                 }
               }
            }
            Start-Sleep -Seconds 2
          }
          
          # Link bulunduktan sonra ajanı çalışır durumda tutuyoruz
          Get-Content "playit.log" -Wait
